package springtest.controllers;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.OutputStream;
import java.util.ArrayList;
import java.util.Collection;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.io.Serializable;
import java.net.URL;

import org.apache.log4j.Logger;
import org.geotools.*;
import org.geotools.data.CachingFeatureSource;
import org.geotools.data.DataStore;
import org.geotools.data.DataStoreFactorySpi;
import org.geotools.data.DataUtilities;
import org.geotools.data.DefaultTransaction;
import org.geotools.data.FeatureSource;
import org.geotools.data.FeatureWriter;
import org.geotools.data.FileDataStore;
import org.geotools.data.FileDataStoreFinder;
import org.geotools.data.Transaction;
import org.geotools.data.collection.ListFeatureCollection;
import org.geotools.data.shapefile.ShapefileDataStore;
import org.geotools.data.shapefile.ShapefileDataStoreFactory;
import org.geotools.data.simple.SimpleFeatureCollection;
import org.geotools.data.simple.SimpleFeatureIterator;
import org.geotools.data.simple.SimpleFeatureSource;
import org.geotools.data.simple.SimpleFeatureStore;
import org.geotools.feature.DefaultFeatureCollection;
import org.geotools.feature.FeatureCollection;
import org.geotools.feature.FeatureCollections;
import org.geotools.feature.simple.SimpleFeatureBuilder;
import org.geotools.feature.simple.SimpleFeatureTypeBuilder;
import org.geotools.geometry.jts.JTS;
import org.geotools.geometry.jts.JTSFactoryFinder;
import org.geotools.map.DefaultMapLayer;
import org.geotools.map.FeatureLayer;
import org.geotools.map.Layer;
import org.geotools.map.MapContent;
import org.geotools.map.MapLayer;

import org.geotools.referencing.CRS;
import org.geotools.referencing.crs.DefaultGeographicCRS;
import org.geotools.styling.SLD;
import org.geotools.styling.Style;
import org.geotools.swing.JMapFrame;
import org.geotools.xml.Encoder;

import org.opengis.feature.GeometryAttribute;
import org.opengis.feature.Property;
import org.opengis.feature.simple.SimpleFeature;
import org.opengis.feature.simple.SimpleFeatureType;
import org.opengis.feature.type.AttributeType;
import org.opengis.feature.type.FeatureType;
import org.opengis.feature.type.GeometryDescriptor;
import org.opengis.feature.type.GeometryType;
import org.opengis.feature.type.Name;
import org.opengis.feature.type.PropertyDescriptor;
import org.opengis.filter.Filter;
import org.opengis.geometry.MismatchedDimensionException;
import org.opengis.referencing.FactoryException;
import org.opengis.referencing.crs.CoordinateReferenceSystem;
import org.opengis.referencing.operation.MathTransform;
import org.opengis.referencing.operation.TransformException;
import org.opengis.util.InternationalString;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;

import com.vividsolutions.jts.awt.PointShapeFactory;
import com.vividsolutions.jts.awt.PointShapeFactory.Point;
import com.vividsolutions.jts.geom.Coordinate;
import com.vividsolutions.jts.geom.Geometry;
import com.vividsolutions.jts.geom.GeometryFactory;
import com.vividsolutions.jts.geom.LinearRing;
import com.vividsolutions.jts.geom.Polygon;
import com.vividsolutions.jts.io.ParseException;
import com.vividsolutions.jts.io.WKTReader;

import org.geotools.kml.*;

@Controller
public class HelloController {
	protected final Logger logger = Logger.getLogger(getClass());

//	GeometryFactory geometryFactory;
//	final SimpleFeatureType TYPE = DataUtilities.createType("Location",
//            "location:Point:srid=4326,name:String,number:Integer");

	@SuppressWarnings("deprecation")
	@RequestMapping("/hello.html")
	public String handleRequest(Model model) throws ParseException, IOException, FactoryException, InstantiationException, IllegalAccessException, MismatchedDimensionException, TransformException {

		logger.debug("Returning index view");
		model.addAttribute("message", "HELLO!!!");

		File file = new File("C:/Programming/Projects/Data/Train-Station/Train-Station/Train_Station.shp");				
		FileDataStore store = FileDataStoreFinder.getDataStore(file);
		SimpleFeatureSource featureSource = store.getFeatureSource();		
		SimpleFeatureType featureType = featureSource.getSchema();
		Style style = SLD.createSimpleStyle(featureType);
		SimpleFeatureCollection simpleFeatureCollection = featureSource.getFeatures();	
				
		//build new feature type
		SimpleFeatureTypeBuilder typeBuilder = new SimpleFeatureTypeBuilder();
		typeBuilder.setName("a-type-name");
		typeBuilder.setCRS(featureType.getCoordinateReferenceSystem());
		typeBuilder.add("location", Polygon.class);
		typeBuilder.add("name", String.class);
		typeBuilder.add("id", Integer.class);		
		SimpleFeatureType type = typeBuilder.buildFeatureType();
		SimpleFeatureBuilder builder = new SimpleFeatureBuilder(type);
		
		DefaultFeatureCollection newBufferFeatures = (DefaultFeatureCollection) FeatureCollections.newCollection();	
		        
	    int id = 0;
	    SimpleFeatureIterator simpleFeatureIterator = simpleFeatureCollection.features();	
        while(simpleFeatureIterator.hasNext()){
			SimpleFeature simpleFeature = simpleFeatureIterator.next();			
			Geometry featureGeometry = (Geometry)simpleFeature.getDefaultGeometryProperty().getValue();
			Geometry bufferGeo = featureGeometry.buffer(0.5);
						
//			 CoordinateReferenceSystem pointCRS = CRS.decode("EPSG:4326",true);
//			 CoordinateReferenceSystem radiusCRS = CRS.decode("EPSG:32630",true);
//			 MathTransform transformToUtm = CRS.findMathTransform(pointCRS, radiusCRS);
//			 Geometry targetGeometry = JTS.transform( featureGeometry, transformToUtm);
//			 Geometry featureBuffer = targetGeometry.buffer(0.1);
//			 featureBuffer.setSRID(32630);
//			 MathTransform transformToGeo = CRS.findMathTransform(radiusCRS, pointCRS);
//			 Geometry bufferGeo = JTS.transform( featureBuffer, transformToGeo);
//			 bufferGeo.setSRID(4326);
				
			//create new feature form polygan and add to newCollection 
			builder.add(bufferGeo);
		    builder.add( "newbuffer"+id);
		    builder.add( id++ );
		    newBufferFeatures.add(builder.buildFeature(null));		      
		    
		    
		    
		} // end while
        
        simpleFeatureIterator.close();         
//        exportToShapeFile(type, newBufferFeatures) ;
        
        
      //export every geometry to KML
	    exportToKML((DefaultFeatureCollection) newBufferFeatures);
				
		//Show On Map
		MapContent map = new MapContent();
		map.setTitle("Quickstart");
		Layer layer = new FeatureLayer(featureSource, style);
		map.addLayer(layer);
		JMapFrame.showMap(map);

		MapLayer myLayer = new DefaultMapLayer(newBufferFeatures, style, "beautiful title");
		MapContent map2 = new MapContent();
		map2.addLayer(myLayer.toLayer());
		JMapFrame.showMap(map2);
		return "hello";

    }
	
	
	// export to KML
	private void exportToKML(DefaultFeatureCollection featureCollection) throws IOException {
		OutputStream output = new FileOutputStream(
				"C:/Programming/Projects/Data/Train-Station/Train-Station/newKML2.kml");

		// GeometryFactory gf = JTSFactoryFinder.getGeometryFactory(null);
		// WKTReader reader = new WKTReader(gf);
		// Geometry triangle = reader.read("POLYGON((0 0, 10 20, 20 0, 0 0))");
		Encoder encoder = new Encoder(new KMLConfiguration());
		encoder.setIndenting(true);
		encoder.encode(featureCollection, KML.kml, output);
	}
	
	// export to KML
	public void exportToShapeFile(SimpleFeatureType type, SimpleFeatureCollection simpleFeatureCollection) throws IOException{
		
		File newFile=new File("C:/Programming/newExport.shp");
		  if(!newFile.exists()){
			  newFile.createNewFile();
		  System.out.println("New file \"myfile.shp\" has been created to the current directory");
		  }
		/*
         * Get an output file name and create the new shapefile
         */
		
        ShapefileDataStoreFactory dataStoreFactory = new ShapefileDataStoreFactory();

        Map<String, Serializable> params = new HashMap<String, Serializable>();
        params.put("url", newFile.toURI().toURL());
        params.put("create spatial index", Boolean.TRUE);

        ShapefileDataStore newDataStore = (ShapefileDataStore) dataStoreFactory.createNewDataStore(params);
        newDataStore.createSchema(type);

        /*
         * You can comment out this line if you are using the createFeatureType method (at end of
         * class file) rather than DataUtilities.createType
         */
        newDataStore.forceSchemaCRS(DefaultGeographicCRS.WGS84);
        
        
        /*
         * Write the features to the shapefile
         */
        Transaction transaction = new DefaultTransaction("create");

        String typeName = newDataStore.getTypeNames()[0];
        SimpleFeatureSource featureSource = newDataStore.getFeatureSource(typeName);

        if (featureSource instanceof SimpleFeatureStore) {
            SimpleFeatureStore featureStore = (SimpleFeatureStore) featureSource;
            
            /*
             * SimpleFeatureStore has a method to add features from a
             * SimpleFeatureCollection object, so we use the ListFeatureCollection
             * class to wrap our list of features.
             */
            SimpleFeatureCollection collection = new ListFeatureCollection(simpleFeatureCollection);

            featureStore.setTransaction(transaction);
            try {
            	System.out.println(" comiiiiiiiiiiiiiiiiiiiiit");
                featureStore.addFeatures(collection);
                transaction.commit();

            } catch (Exception problem) {
                problem.printStackTrace();
                transaction.rollback();

            } finally {
                transaction.close();
            }
            System.exit(0); // success!
        } else {
            System.out.println(typeName + " does not support read/write access");
            System.exit(1);
        }
    
	}
}


